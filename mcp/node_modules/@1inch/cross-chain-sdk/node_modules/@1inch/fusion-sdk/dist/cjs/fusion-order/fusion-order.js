"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FusionOrder = void 0;
const tslib_1 = require("tslib");
const limit_order_sdk_1 = require("@1inch/limit-order-sdk");
const assert_1 = tslib_1.__importDefault(require("assert"));
const fusion_extension_1 = require("./fusion-extension");
const auction_details_1 = require("./auction-details");
const settlement_post_interaction_data_1 = require("./settlement-post-interaction-data");
const source_track_1 = require("./source-track");
const auction_calculator_1 = require("../auction-calculator");
const constants_1 = require("../constants");
const amounts_1 = require("../utils/amounts");
const time_1 = require("../utils/time");
class FusionOrder {
    constructor(settlementExtensionContract, orderInfo, auctionDetails, postInteractionData, extra = FusionOrder.defaultExtra, extension = new fusion_extension_1.FusionExtension(settlementExtensionContract, auctionDetails, postInteractionData, extra.permit
        ? new limit_order_sdk_1.Interaction(orderInfo.makerAsset, extra.permit)
        : undefined)) {
        this.settlementExtensionContract = settlementExtensionContract;
        const allowPartialFills = extra.allowPartialFills ??
            FusionOrder.defaultExtra.allowPartialFills;
        const allowMultipleFills = extra.allowMultipleFills ??
            FusionOrder.defaultExtra.allowMultipleFills;
        const unwrapWETH = extra.unwrapWETH ?? FusionOrder.defaultExtra.unwrapWETH;
        const enablePermit2 = extra.enablePermit2 ?? FusionOrder.defaultExtra.enablePermit2;
        const orderExpirationDelay = extra.orderExpirationDelay ??
            FusionOrder.defaultExtra.orderExpirationDelay;
        const deadline = auctionDetails.startTime +
            auctionDetails.duration +
            orderExpirationDelay;
        const makerTraits = limit_order_sdk_1.MakerTraits.default()
            .withExpiration(deadline)
            .setPartialFills(allowPartialFills)
            .setMultipleFills(allowMultipleFills)
            .enablePostInteraction();
        if (makerTraits.isBitInvalidatorMode()) {
            (0, assert_1.default)(extra.nonce !== undefined, 'Nonce required, when partial fill or multiple fill disallowed');
        }
        if (unwrapWETH) {
            makerTraits.enableNativeUnwrap();
        }
        if (enablePermit2) {
            makerTraits.enablePermit2();
        }
        if (extra.nonce !== undefined) {
            makerTraits.withNonce(extra.nonce);
        }
        const receiver = postInteractionData.integratorFee?.ratio
            ? settlementExtensionContract
            : orderInfo.receiver;
        const builtExtension = extension.build();
        const salt = limit_order_sdk_1.LimitOrder.buildSalt(builtExtension, orderInfo.salt);
        const saltWithInjectedTrackCode = orderInfo.salt
            ? salt
            : (0, source_track_1.injectTrackCode)(salt, extra.source);
        this.inner = new limit_order_sdk_1.LimitOrder({
            ...orderInfo,
            receiver,
            salt: saltWithInjectedTrackCode
        }, makerTraits, builtExtension);
        this.fusionExtension = extension;
    }
    get extension() {
        return this.inner.extension;
    }
    get maker() {
        return this.inner.maker;
    }
    get takerAsset() {
        return this.inner.takerAsset;
    }
    get makerAsset() {
        return this.inner.makerAsset;
    }
    get takingAmount() {
        return this.inner.takingAmount;
    }
    get makingAmount() {
        return this.inner.makingAmount;
    }
    get receiver() {
        return this.inner.receiver;
    }
    get deadline() {
        return this.inner.makerTraits.expiration() || 0n;
    }
    get auctionStartTime() {
        return this.fusionExtension.auctionDetails.startTime;
    }
    get auctionEndTime() {
        const { startTime, duration } = this.fusionExtension.auctionDetails;
        return startTime + duration;
    }
    get isBitInvalidatorMode() {
        return this.inner.makerTraits.isBitInvalidatorMode();
    }
    get partialFillAllowed() {
        return this.inner.makerTraits.isPartialFillAllowed();
    }
    get multipleFillsAllowed() {
        return this.inner.makerTraits.isMultipleFillsAllowed();
    }
    get nonce() {
        return this.inner.makerTraits.nonceOrEpoch();
    }
    get salt() {
        return this.inner.salt;
    }
    static new(settlementExtension, orderInfo, details, extra) {
        return new FusionOrder(settlementExtension, orderInfo, details.auction, settlement_post_interaction_data_1.SettlementPostInteractionData.new({
            bankFee: details.fees?.bankFee || 0n,
            integratorFee: details.fees?.integratorFee,
            whitelist: details.whitelist,
            resolvingStartTime: details.resolvingStartTime ?? (0, time_1.now)(),
            customReceiver: orderInfo.receiver
        }), extra);
    }
    static fromDataAndExtension(order, extension) {
        const settlementContract = limit_order_sdk_1.Address.fromFirstBytes(extension.makingAmountData);
        (0, assert_1.default)(limit_order_sdk_1.Address.fromFirstBytes(extension.takingAmountData).equal(settlementContract) &&
            limit_order_sdk_1.Address.fromFirstBytes(extension.postInteraction).equal(settlementContract), 'Invalid extension, all calls should be to the same address');
        const makerTraits = new limit_order_sdk_1.MakerTraits(BigInt(order.makerTraits));
        (0, assert_1.default)(!makerTraits.isPrivate(), 'fusion order can not be private');
        (0, assert_1.default)(makerTraits.hasPostInteraction(), 'post-interaction must be enabled');
        const auctionDetails = auction_details_1.AuctionDetails.fromExtension(extension);
        const postInteractionData = settlement_post_interaction_data_1.SettlementPostInteractionData.fromExtension(extension);
        const deadline = makerTraits.expiration();
        const orderExpirationDelay = deadline === null
            ? undefined
            : deadline - auctionDetails.startTime - auctionDetails.duration;
        return new FusionOrder(settlementContract, {
            salt: BigInt(order.salt) >> 160n,
            maker: new limit_order_sdk_1.Address(order.maker),
            receiver: new limit_order_sdk_1.Address(order.receiver),
            makerAsset: new limit_order_sdk_1.Address(order.makerAsset),
            takerAsset: new limit_order_sdk_1.Address(order.takerAsset),
            makingAmount: BigInt(order.makingAmount),
            takingAmount: BigInt(order.takingAmount)
        }, auctionDetails, postInteractionData, {
            allowMultipleFills: makerTraits.isMultipleFillsAllowed(),
            allowPartialFills: makerTraits.isPartialFillAllowed(),
            enablePermit2: makerTraits.isPermit2(),
            nonce: makerTraits.nonceOrEpoch(),
            permit: extension.makerPermit === constants_1.ZX
                ? undefined
                : limit_order_sdk_1.Interaction.decode(extension.makerPermit).data,
            unwrapWETH: makerTraits.isNativeUnwrapEnabled(),
            orderExpirationDelay
        });
    }
    build() {
        return this.inner.build();
    }
    getOrderHash(chainId) {
        return this.inner.getOrderHash(chainId);
    }
    getTypedData(chainId) {
        return this.inner.getTypedData(chainId);
    }
    getCalculator() {
        return auction_calculator_1.AuctionCalculator.fromAuctionData(this.fusionExtension.postInteractionData, this.fusionExtension.auctionDetails);
    }
    calcTakingAmount(makingAmount, time, blockBaseFee = 0n) {
        const takingAmount = (0, amounts_1.calcTakingAmount)(makingAmount, this.makingAmount, this.takingAmount);
        const calculator = this.getCalculator();
        const bump = calculator.calcRateBump(time, blockBaseFee);
        return calculator.calcAuctionTakingAmount(takingAmount, bump);
    }
    canExecuteAt(executor, executionTime) {
        return this.fusionExtension.postInteractionData.canExecuteAt(executor, executionTime);
    }
    isExpiredAt(time) {
        return time > this.deadline;
    }
    getResolverFee(filledMakingAmount) {
        return ((this.fusionExtension.postInteractionData.bankFee *
            FusionOrder._ORDER_FEE_BASE_POINTS *
            filledMakingAmount) /
            this.makingAmount);
    }
    isExclusiveResolver(wallet) {
        return this.fusionExtension.postInteractionData.isExclusiveResolver(wallet);
    }
    isExclusivityPeriod(time = (0, time_1.now)()) {
        return this.fusionExtension.postInteractionData.isExclusivityPeriod(time);
    }
}
exports.FusionOrder = FusionOrder;
FusionOrder._ORDER_FEE_BASE_POINTS = 10n ** 15n;
FusionOrder.defaultExtra = {
    allowPartialFills: true,
    allowMultipleFills: true,
    unwrapWETH: false,
    enablePermit2: false,
    orderExpirationDelay: 12n
};
//# sourceMappingURL=fusion-order.js.map